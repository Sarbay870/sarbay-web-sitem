{% extends "layout.html" %}

{% block content %}

<style>
    /* ... Ã–nceki stiller ... */
    .form-row {
        display: flex;
        flex-wrap: wrap; /* Mobil iÃ§in kaydÄ±r */
        gap: 20px;
        margin-bottom: 15px;
    }
    .form-group {
        flex-grow: 1;
        min-width: 0;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }
    .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }
    .btn-submit {
        display: block;
        width: 100%;
        margin-top: 10px;
    }
    .list-group-item span {
        color: #333;
    }
    .list-group-item.selected {
        background-color: #5a67d8;
        border-left: 5px solid #2563eb;
        padding-left: 20px;
    }
    .list-group-item.selected span, .list-group-item.selected small, .list-group-item.selected strong {
        color: #fff !important;
    }

    /* === ðŸ‘‘ KRAL GÃœNCELLEMESÄ°: YENÄ° AÄžAÃ‡ (TREE) STÄ°LLERÄ° ðŸ‘‘ === */
    .calisma-container {
        display: flex;
        flex-wrap: wrap; /* Mobil iÃ§in kaydÄ±r */
        gap: 20px;
    }
    .calisma-form-bolumu {
        flex: 2; /* Form 2 birim yer kaplasÄ±n */
        min-width: 300px; /* Mobil iÃ§in minimum geniÅŸlik */
    }
    .calisma-agac-bolumu {
        flex: 1; /* AÄŸaÃ§ 1 birim yer kaplasÄ±n */
        min-width: 250px; /* Mobil iÃ§in minimum geniÅŸlik */
        max-height: 480px; /* YÃ¼ksekliÄŸini artÄ±rdÄ±k */
        overflow-y: auto;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
    }

    .agac-listesi {
        list-style-type: none;
        padding-left: 0;
    }
    .agac-listesi ul {
        list-style-type: none;
        padding-left: 20px;
    }
    .agac-listesi li {
        margin-bottom: 5px;
    }
    .agac-listesi .agac-dal { /* BÃ¶lÃ¼m veya Ders (KlasÃ¶r) */
        font-weight: bold;
        cursor: pointer;
        color: #333;
    }
    .agac-listesi .agac-dal::before {
        content: 'ðŸ“ '; /* KlasÃ¶r ikonu */
    }
    .agac-listesi .agac-yaprak { /* Konu (Dosya) */
        cursor: pointer;
        color: #007bff; /* TÄ±klanabilir renk */
    }
    .agac-listesi .agac-yaprak:hover {
        text-decoration: underline;
    }
    .agac-listesi .agac-yaprak::before {
        content: 'ðŸ“„ '; /* Dosya ikonu */
    }
    .agac-listesi ul {
        display: none; /* BaÅŸlangÄ±Ã§ta kapalÄ± */
    }
    .agac-listesi li.acik > ul {
        display: block; /* TÄ±klanÄ±nca aÃ§Ä±lacak */
    }
    
    /* === ðŸ‘‘ KRAL GÃœNCELLEMESÄ°: SAAT Ã‡EVÄ°RÄ°CÄ° STÄ°LLERÄ° ðŸ‘‘ === */
    .saat-group {
        display: flex;
        gap: 10px;
        align-items: flex-end; /* Buton ve input'u alttan hizala */
    }
    .saat-group .form-group {
        flex-grow: 0; /* Otomatik bÃ¼yÃ¼mesin */
    }
    .saat-group .btn-cevir {
        padding: 10px 15px;
        height: 40px; /* Input ile aynÄ± yÃ¼kseklik */
        flex-shrink: 0; /* KÃ¼Ã§Ã¼lmesin */
    }
    
</style>

<!-- === ðŸ‘‘ KRAL GÃœNCELLEMESÄ°: SAYFAYI Ä°KÄ°YE BÃ–LME ðŸ‘‘ === -->
<div class="calisma-container">

    <!-- BÃ–LÃœM 1: FORM (SAAT Ã‡EVÄ°RÄ°CÄ° EKLENDÄ°) -->
    <div class="calisma-form-bolumu">
        <div class="card">
            <div class="card-header">
                <h2>Yeni Ã‡alÄ±ÅŸma KaydÄ± Ekle</h2>
            </div>
            <div class="card-content">
                <form method="POST" action="{{ url_for('calisma_takibi_sayfasi') }}">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ders_adi">Ders AdÄ±</label>
                            <input type="text" id="ders_adi" name="ders_adi" required>
                        </div>
                        <div class="form-group">
                            <label for="konu_adi">Konu AdÄ±</label>
                            <input type="text" id="konu_adi" name="konu_adi" required>
                        </div>
                    </div>
                    
                    <!-- === ðŸ‘‘ KRAL GÃœNCELLEMESÄ°: SAAT VE DAKÄ°KA GRUBU ðŸ‘‘ === -->
                    <div class="form-row saat-group">
                        <div class="form-group" style="flex-grow: 1;">
                            <label for="saat_input">Saat</label>
                            <!-- Saat girmek iÃ§in yeni kutu -->
                            <input type="number" id="saat_input" min="0" step="any" placeholder="Ã–rn: 1.5">
                        </div>
                        <div class="form-group" style="flex-grow: 0;">
                            <!-- Bu buton formu gÃ¶ndermez (type="button") -->
                            <button type="button" id="btn_saat_cevir" class="btn btn-neutral btn-cevir">Dakikaya Ã‡evir</button>
                        </div>
                        <div class="form-group" style="flex-grow: 1;">
                            <label for="sure_dk">SÃ¼re (dk)</label>
                            <input type="number" id="sure_dk" name="sure_dk" min="1" required placeholder="0">
                        </div>
                    </div>
                    <!-- === ðŸ‘‘ GÃœNCELLEME BÄ°TTÄ° ðŸ‘‘ === -->

                    <button type="submit" class="btn btn-add btn-submit">Kaydet</button>
                </form>
            </div>
        </div>
    </div>

    <!-- BÃ–LÃœM 2: HIZLI EKLE AÄžACI (Bu zaten tam istediÄŸin gibiydi) -->
    <div class="calisma-agac-bolumu">
        <h3 style="margin-top: 0; padding-bottom: 5px; border-bottom: 1px solid #ccc;">HÄ±zlÄ± Ekle (Ã‡alÄ±ÅŸma)</h3>
        
        <!-- app.py'den gelen 'calisma_data_agaci' verisini kullanarak aÄŸacÄ± Ã§izer -->
        {% if calisma_data_agaci and 'Hata' not in calisma_data_agaci %}
            <ul class="agac-listesi">
                {% for bolum, dersler in calisma_data_agaci.items() %}
                    <!-- BÃ¶lÃ¼m (SÃ¶zel, SayÄ±sal vb.) -->
                    <li onclick="agacTikla(event)">
                        <span class="agac-dal">{{ bolum }}</span>
                        <ul>
                            {% for ders, konular in dersler.items() %}
                                <!-- Ders (Matematik, Fizik vb.) -->
                                <li onclick="agacTikla(event)">
                                    <span class="agac-dal">{{ ders }}</span>
                                    <ul>
                                        {% for konu in konular %}
                                            <!-- Konu (Limit.txt, TÃ¼rev.txt vb.) -->
                                            <li class="agac-yaprak" 
                                                onclick="konuSec(event, '{{ ders }}', '{{ konu }}')">
                                                {{ konu }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endfor %}
            </ul>
        {% elif 'Hata' in calisma_data_agaci %}
             <p class="yok">{{ calisma_data_agaci['Hata'][0] }}</p>
        {% else %}
            <p class="yok">'Ã‡alÄ±ÅŸma' klasÃ¶rÃ¼nde (BÃ¶lÃ¼m/Ders/Konu.txt) formatÄ±nda iÃ§erik bulunamadÄ±.</p>
        {% endif %}
    </div>

</div>
<!-- === ðŸ‘‘ SAYFA BÃ–LÃœNME BÄ°TTÄ° ðŸ‘‘ === -->

<br>

<!-- LÄ°STE KISMI (DeÄŸiÅŸmedi) -->
<div class="card">
    <div class="card-header" style="justify-content: space-between;">
        <h2>TÃ¼m Ã‡alÄ±ÅŸmalar</h2>
        <button id="btn-sil-calisma" class="btn btn-small btn-delete">SeÃ§ili KaydÄ± Sil</button>
    </div>
    <div class="list-group" id="calisma-listesi-container">
        {% if calisma_listesi %}
            {% for calisma in calisma_listesi %}
                <!-- data-id ve tÄ±klama olayÄ± iÃ§in sÄ±nÄ±f -->
                <div class="list-group-item selectable-item" data-id="{{ calisma.id }}">
                    <span>
                        <strong>{{ calisma.ders }}</strong>: {{ calisma.konu }} ({{ calisma.sure }} dk)
                        <small style="color: #666; margin-left: 10px;">- {{ calisma.tarih }}</small>
                    </span>
                </div>
            {% endfor %}
        {% else %}
            <div class="card-content">
                <p class="yok">HenÃ¼z kayÄ±tlÄ± bir Ã§alÄ±ÅŸma yok.</p>
            </div>
        {% endif %}
    </div>
</div>


<!-- JAVASCRIPT KODU (SeÃ§me, Silme ve YENÄ° SAAT Ã‡EVÄ°RÄ°CÄ°) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // SeÃ§ili Ã¶ÄŸenin ID'sini tutacak deÄŸiÅŸken
        let selectedItemId = null;
        
        // TÃ¼m seÃ§ilebilir Ã¶ÄŸeleri ve butonlarÄ± al
        const items = document.querySelectorAll('.selectable-item');
        const deleteButton = document.getElementById('btn-sil-calisma');
        
        // 1. SeÃ§im OlayÄ±
        items.forEach(item => {
            item.addEventListener('click', function() {
                items.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
                selectedItemId = this.getAttribute('data-id');
            });
        });
        
        // 2. Silme OlayÄ±
        if (deleteButton) {
            deleteButton.addEventListener('click', function() {
                
                if (!selectedItemId) {
                    console.log("Silme hatasÄ±: SeÃ§ili ID yok."); // alert yerine console
                    return;
                }

                if (selectedItemId === 'silinemez' || selectedItemId.startsWith('silinemez_') || selectedItemId.startsWith('list_item_')) {
                    console.log("Silme hatasÄ±: Bu kayÄ±t silinemez."); // alert yerine console
                    return;
                }

                // Silme iÅŸlemi iÃ§in ID'yi yolla
                window.location.href = '{{ url_for("sil_calisma", calisma_id="PLACEHOLDER") }}'.replace('PLACEHOLDER', selectedItemId);
            });
        }
        
        // === ðŸ‘‘ KRAL GÃœNCELLEMESÄ°: SAAT Ã‡EVÄ°RÄ°CÄ° JS ðŸ‘‘ ===
        const saatInput = document.getElementById('saat_input');
        const dakikaInput = document.getElementById('sure_dk');
        const cevirButonu = document.getElementById('btn_saat_cevir');

        if (cevirButonu) {
            cevirButonu.addEventListener('click', function() {
                // DeÄŸerleri al, boÅŸsa 0 say
                let saatDegeri = parseFloat(saatInput.value) || 0;
                let mevcutDakika = parseInt(dakikaInput.value) || 0;
                
                // ÅžAK ÅžAK ÅžAK! 60 ile Ã§arp
                let eklenecekDakika = Math.round(saatDegeri * 60);
                
                // Mevcut dakikaya ekle ve sonucu yaz
                dakikaInput.value = mevcutDakika + eklenecekDakika;
                
                // Saat kutusunu temizle
                saatInput.value = '';
            });
        }
        // === ðŸ‘‘ JS GÃœNCELLEMESÄ° BÄ°TTÄ° ðŸ‘‘ ===
    });

    // === AÄžAÃ‡ (TREE) JAVASCRIPT'Ä° (DeÄŸiÅŸmedi) ===

    // AÄŸaÃ§ dallarÄ±nÄ± (klasÃ¶rleri) aÃ§Ä±p kapar
    function agacTikla(event) {
        const li = event.currentTarget; // TÄ±klanan <li>
        li.classList.toggle('acik');
        event.stopPropagation();
    }

    // AÄŸaÃ§ yapraÄŸÄ±na (konuya) tÄ±klanÄ±nca formu doldurur
    function konuSec(event, dersAdi, konuAdi) {
        const dersInput = document.getElementById('ders_adi');
        const konuInput = document.getElementById('konu_adi');
        
        // ÅžAK diye doldur!
        if (dersInput) {
            dersInput.value = dersAdi;
        }
        if (konuInput) {
            konuInput.value = konuAdi;
        }
        
        event.stopPropagation();
    }
    // === ðŸ‘‘ JAVASCRIPT BÄ°TTÄ° ðŸ‘‘ ===
</script>

{% endblock %}